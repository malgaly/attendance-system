<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi2YbYuNin2YUg2KXYr9in2LHYqSDYrdmC2YjYsSDYp9mE2YXZiNi42YHZitmGIiwic2hvcnRfbmFtZSI6Itin2YTZhdmI2LjZgdmK2YYiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzRGNDZFNSJ9">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #312E81;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1F2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 24px;
            height: 24px;
            color: #4F46E5;
        }

        .input-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary { background: #4F46E5; color: white; }
        .btn-primary:hover { background: #4338CA; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3); }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover { background: #047857; }
        .btn-info { background: #2563EB; color: white; }
        .btn-info:hover { background: #1D4ED8; }
        .btn-danger { background: #DC2626; color: white; padding: 8px 12px; }
        .btn-danger:hover { background: #B91C1C; }
        .btn-archive { background: #9CA3AF; color: white; padding: 5px 10px; font-size: 0.8rem; }
        .btn-archive:hover { background: #6B7280; }
        .btn-advances { background-color: #EAB308; color: white; }
        .btn-advances:hover { background-color: #D97706; }
        
        .attendance-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #F9FAFB; border-radius: 8px; margin-bottom: 12px; }
        .attendance-buttons { display: flex; gap: 10px; }
        .attendance-btn { width: 50px; height: 50px; border: none; border-radius: 8px; font-size: 1.5rem; font-weight: bold; cursor: pointer; transition: all 0.3s; background: #E5E7EB; color: #6B7280; }
        .attendance-btn:hover { transform: scale(1.1); }
        .attendance-btn.active-full { background: #059669; color: white; }
        .attendance-btn.active-half { background: #F59E0B; color: white; }
        .attendance-btn.active-absent { background: #DC2626; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        thead { background: #4F46E5; color: white; }
        th, td { padding: 15px; text-align: center; }
        th { font-weight: 600; }
        tbody tr { border-bottom: 1px solid #E5E7EB; transition: background 0.2s; }
        tbody tr:hover { background: #F9FAFB; }
        tfoot { background: #F3F4F6; font-weight: bold; }

        .empty-state { text-align: center; padding: 40px; color: #9CA3AF; font-size: 1.1rem; }
        .employee-name { font-weight: 600; color: #1F2937; }
        .salary-amount { color: #059669; font-weight: bold; }
        .days-count { color: #4F46E5; font-weight: 600; }
        .hidden { display: none; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal.show { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background-color: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; padding: 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.8rem; }
        .close-btn { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .close-btn:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }
        .modal-body { padding: 25px; }
        
        #advancesModal .modal-content { max-width: 1000px; }
        #advancesModal .card { box-shadow: none; border: 1px solid #e5e7eb; }
        
        .attendance-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .attendance-table thead { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; }
        .attendance-table th { padding: 15px; text-align: center; font-weight: 600; font-size: 1.1rem; }
        .attendance-table td { padding: 12px; text-align: center; border-bottom: 1px solid #E5E7EB; }
        .day-cell { font-weight: bold; font-size: 1.1rem; color: #1F2937; }
        .status-cell { font-size: 1.5rem; }
        .row-weekend-highlight { background: #DBEAFE !important; }
        .row-full { background: #D1FAE5 !important; }
        .row-half { background: #FEF3C7 !important; }
        .row-absent { background: #FDDEDE !important; }
        .employee-summary { background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .summary-item { text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .summary-label { font-size: 0.9rem; color: #6B7280; margin-bottom: 8px; font-weight: 600; }
        .summary-value { font-size: 1.8rem; font-weight: bold; color: #1F2937; }
        .btn-view { background: #8B5CF6; color: white; padding: 8px 16px; font-size: 0.9rem; }
        .btn-view:hover { background: #7C3AED; }
        
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: fit-content; }
        .matrix-table th, .matrix-table td { padding: 10px 8px; text-align: center; border: 1px solid #E5E7EB; vertical-align: middle; }
        .matrix-table thead th { background-color: #4F46E5; color: white; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        .matrix-table .day-col { position: sticky; left: 0; background: white; font-weight: bold; text-align: center; min-width: 100px; z-index: 11; border-left: 2px solid #4F46E5; }
        .status-full { background-color: #D1FAE5; } 
        .status-half { background-color: #FEF3C7; } 
        .status-absent { background-color: #FEE2E2; color: #991B1B; } 
        .status-weekend { background-color: #DBEAFE; color: #1E40AF; } 
        .matrix-table tfoot td { background-color: #E0E7FF !important; font-weight: bold; border-top: 3px solid #4F46E5; }
        
        .month-controls { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .month-info { text-align: center; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .month-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-month { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-month:hover { background: rgba(255,255,255,0.3); }

        .employee-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; }
        .employee-item { background: #F9FAFB; padding: 15px; border-radius: 8px; border: 2px solid #E5E7EB; }
        .employee-item.active { border-color: #059669; background: #F0FDF4; }
        .inactive-employee-management { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #E5E7EB; }
        .inactive-employees-list-container { border: 1px solid #E5E7EB; border-radius: 8px; max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding: 0 15px; }
        
        @media print {
            body > .container, .modal { display: none !important; }
            #printableArea.show { display: block; position: static; width: auto; height: auto; background-color: white; overflow: visible; padding: 0; }
            #printableArea .modal-content { max-width: 100%; box-shadow: none; border-radius: 0; }
            #printableArea .modal-header { display: none; }
            #printableArea .modal-body { padding: 0; }
            #printableArea [style*="overflow"] { overflow: visible !important; }
            .matrix-table { min-width: 100%; }
            .matrix-table thead th, .matrix-table .day-col { position: static !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</h1>

        <div class="month-controls">
            <div class="month-info" id="currentMonthInfo"></div>
            <div class="month-actions">
                <button class="btn-month" onclick="switchToPreviousMonth()">ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button class="btn-month" onclick="switchToCurrentMonth()">ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                <button class="btn-month" onclick="switchToNextMonth()">ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="btn-month" onclick="copyMonthData()">ğŸ“‹ Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </div>
            <div class="input-group">
                <button class="btn-success" onclick="exportData()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <label class="btn-info" style="cursor: pointer;">
                    ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">
                </label>
                <button class="btn-advances" onclick="openAdvancesModal()">ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
            <div class="input-group">
                <input type="text" id="employeeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                <input type="number" id="employeeSalary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ" min="0" step="0.01">
                <button class="btn-primary" onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
            </div>
            <div style="margin-top: 20px; border-top: 1px solid #E5E7EB; padding-top: 15px;">
                <h3 style="margin-bottom: 15px;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                <div id="currentMonthEmployeesList" class="employee-list"></div>
            </div>
            <div style="margin-top: 20px; border-top: 1px solid #E5E7EB; padding-top: 15px;">
                <h3 style="margin-bottom: 15px;">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ† / Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†</h3>
                <div class="input-group">
                    <select id="inactiveEmployeesSelect" style="flex: 2;">
                        <option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
                    </select>
                    <button class="btn-success" onclick="activateSelectedEmployee()" style="flex: 1;">âœ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                </div>
                <h4 style="margin: 15px 0 10px;">ğŸ§¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (Ù„Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)</h4>
                <div id="inactiveEmployeesListContainer" class="inactive-employees-list-container"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
            <div class="input-group">
                <div style="flex: 1;">
                    <label style="font-weight: 600; display: block; margin-bottom: 5px;">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="attendanceDate" onchange="updateDayName(); renderAttendanceList();" style="width: 100%;">
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: 600; display: block; margin-bottom: 5px;">Ø§Ù„ÙŠÙˆÙ…:</label>
                    <input type="text" id="dayName" readonly style="background: #F3F4F6; cursor: default; font-weight: bold;">
                </div>
            </div>
            <div id="attendanceList"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ’° Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
            <div class="input-group">
                <select id="reportMonth" onchange="switchMonth()">
                    <option value="0">ÙŠÙ†Ø§ÙŠØ±</option><option value="1">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="2">Ù…Ø§Ø±Ø³</option>
                    <option value="3">Ø¥Ø¨Ø±ÙŠÙ„</option><option value="4">Ù…Ø§ÙŠÙˆ</option><option value="5">ÙŠÙˆÙ†ÙŠÙˆ</option>
                    <option value="6">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="7">Ø£ØºØ³Ø·Ø³</option><option value="8">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                    <option value="9">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="10">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="11">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                </select>
                <input type="number" id="reportYear" min="2020" max="2100" onchange="switchMonth()">
                <button class="btn-primary" onclick="updateReport()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button class="btn-info" onclick="showMatrixReport()">Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ø§Ù…Ù„</button>
            </div>
            <div id="reportTable"></div>
        </div>
    </div>

    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalEmployeeName"></h2>
                <button class="close-btn" onclick="closeModal('employeeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="employee-summary" id="employeeSummary"></div>
                <h3 style="margin-bottom: 15px;">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                <div id="calendarDays"></div>
            </div>
        </div>
    </div>

    <div id="advancesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù (<span id="advancesModalMonthInfo"></span>)</h2>
                <button class="close-btn" onclick="closeModal('advancesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-title">â• ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div class="input-group">
                        <select id="advanceEmployeeId" style="flex: 2;"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option></select>
                        <input type="date" id="advanceDate" style="flex: 1;">
                        <input type="number" id="advanceAmount" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„ÙØ©" min="0" step="0.01" style="flex: 1;">
                        <button class="btn-info" onclick="addAdvance()">â• ØªØ³Ø¬ÙŠÙ„</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">âŒ Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ù</div>
                    <div class="input-group" style="border-bottom: 1px solid #E5E7EB; padding-bottom: 15px;">
                        <select id="clearSingleAdvanceEmployeeId" style="flex: 2;"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option></select>
                        <input type="date" id="clearSingleAdvanceDate" style="flex: 1;">
                        <button class="btn-danger" onclick="clearSingleAdvanceByDate()" style="flex: 1;">âŒ Ù…Ø³Ø­ Ø§Ù„Ø³Ù„ÙØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
                    </div>
                    <div class="input-group" style="margin-top: 15px;">
                        <select id="clearAdvanceEmployeeId" style="flex: 2;"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option></select>
                        <button class="btn-danger" onclick="clearAllAdvancesForEmployee()" style="flex: 1;">ğŸ§¹ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ù Ù„Ù„Ù…ÙˆØ¸Ù</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ù</div>
                    <button class="btn-primary" onclick="showAdvancesMatrixReport()">Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ù„Ù Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="printableArea" class="modal">
        <div class="modal-content" style="max-width: 95vw;">
            <div class="modal-header">
                <h2 id="printableAreaTitle"></h2>
                <div>
                    <button class="btn-success" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="close-btn" onclick="closeModal('printableArea')">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="printableContent" style="overflow-x: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        let employees = [];
        let monthlyData = {};
        let currentMonthKey = '';

        window.onload = function() {
            setTodayDate();
            loadData();
            setCurrentMonthYear();
            initializeCurrentMonth();
            updateAllUI();
        };
        
        function updateAllUI() {
            updateMonthInfo();
            renderCurrentMonthEmployeesList();
            renderInactiveEmployeesLists();
            renderAttendanceList();
            renderEmployeeSelects();
            updateReport();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('advanceDate').value = today;
            document.getElementById('clearSingleAdvanceDate').value = today;
            updateDayName();
        }

        function updateDayName() {
            const dateInput = document.getElementById('attendanceDate').value;
            if (dateInput) {
                const date = new Date(dateInput + 'T00:00:00');
                const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                const dayOfWeek = date.getDay();
                const dayNameInput = document.getElementById('dayName');
                dayNameInput.value = dayNames[dayOfWeek];
                if (dayOfWeek === 5 || dayOfWeek === 6) { // Friday or Saturday
                    dayNameInput.style.background = '#FEE2E2';
                    dayNameInput.style.color = '#DC2626';
                } else {
                    dayNameInput.style.background = '#F3F4F6';
                    dayNameInput.style.color = '#1F2937';
                }
            }
        }

        function setCurrentMonthYear() {
            const now = new Date();
            document.getElementById('reportMonth').value = now.getMonth();
            document.getElementById('reportYear').value = now.getFullYear();
        }

        function getCurrentMonthKey() {
            const reportMonth = parseInt(document.getElementById('reportMonth').value);
            const reportYear = parseInt(document.getElementById('reportYear').value);
            return `${reportYear}-${String(reportMonth + 1).padStart(2, '0')}`;
        }

        function initializeCurrentMonth() {
            currentMonthKey = getCurrentMonthKey();
            if (!monthlyData[currentMonthKey]) {
                monthlyData[currentMonthKey] = { employees: [], attendance: {}, advances: [] };
                const activeEmployees = employees.filter(emp => !emp.isDeleted);
                activeEmployees.forEach(emp => {
                    if (!emp.removedMonths || !emp.removedMonths.includes(currentMonthKey)) {
                        monthlyData[currentMonthKey].employees.push(JSON.parse(JSON.stringify(emp)));
                    }
                });
                saveData();
            }
        }

        function updateMonthInfo() {
            const reportMonth = parseInt(document.getElementById('reportMonth').value);
            const reportYear = parseInt(document.getElementById('reportYear').value);
            const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø¥Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            const monthText = `${monthNames[reportMonth]} ${reportYear}`;
            document.getElementById('currentMonthInfo').textContent = `Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${monthText}`;
            document.getElementById('advancesModalMonthInfo').textContent = monthText;
        }

        function loadData() {
            const saved = localStorage.getItem('employeeData');
            if (saved) {
                employees = JSON.parse(saved);
                employees.forEach(emp => {
                    emp.isDeleted = emp.isDeleted || false;
                    emp.removedMonths = emp.removedMonths || [];
                });
            }
            monthlyData = JSON.parse(localStorage.getItem('monthlyEmployeeData') || '{}');
        }

        function saveData() {
            localStorage.setItem('employeeData', JSON.stringify(employees));
            localStorage.setItem('monthlyEmployeeData', JSON.stringify(monthlyData));
        }

        function switchMonth() {
            currentMonthKey = getCurrentMonthKey();
            initializeCurrentMonth();
            updateAllUI();
        }

        function switchToPreviousMonth() {
            let month = parseInt(document.getElementById('reportMonth').value);
            let year = parseInt(document.getElementById('reportYear').value);
            if (--month < 0) { month = 11; year--; }
            document.getElementById('reportMonth').value = month;
            document.getElementById('reportYear').value = year;
            switchMonth();
        }

        function switchToNextMonth() {
            let month = parseInt(document.getElementById('reportMonth').value);
            let year = parseInt(document.getElementById('reportYear').value);
            if (++month > 11) { month = 0; year++; }
            document.getElementById('reportMonth').value = month;
            document.getElementById('reportYear').value = year;
            switchMonth();
        }

        function switchToCurrentMonth() {
            const now = new Date();
            document.getElementById('reportMonth').value = now.getMonth();
            document.getElementById('reportYear').value = now.getFullYear();
            switchMonth();
        }
        
        function copyMonthData() {
            const sourceMonthKey = currentMonthKey;
            const targetMonthKey = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ø¨ØµÙŠØºØ© YYYY-MM):', sourceMonthKey);
            if (targetMonthKey && monthlyData[sourceMonthKey]) {
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª ${sourceMonthKey} Ø¥Ù„Ù‰ ${targetMonthKey}ØŸ`)) {
                    monthlyData[targetMonthKey] = JSON.parse(JSON.stringify(monthlyData[sourceMonthKey]));
                    saveData();
                    alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                }
            }
        }
        
        // Employee Management
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const salary = parseFloat(document.getElementById('employeeSalary').value);
            if (!name || isNaN(salary) || salary <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ ÙˆØ±Ø§ØªØ¨ ÙŠÙˆÙ…ÙŠ!');
                return;
            }
            if (employees.find(e => e.name.toLowerCase() === name.toLowerCase() && !e.isDeleted)) {
                alert('ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸Ù Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!');
                return;
            }
            const employee = { id: Date.now(), name, dailySalary: salary, removedMonths: [], isDeleted: false };
            employees.push(employee);
            
            const [startYear, startMonth] = currentMonthKey.split('-').map(Number);
            for (let y = startYear; y < startYear + 5; y++) {
                for (let m = (y === startYear ? startMonth : 1); m <= 12; m++) {
                    const monthKey = `${y}-${String(m).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { employees: [], attendance: {}, advances: [] };
                    }
                    if (!monthlyData[monthKey].employees.some(e => e.id === employee.id)) {
                        monthlyData[monthKey].employees.push(JSON.parse(JSON.stringify(employee)));
                    }
                }
            }
            saveData();
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeSalary').value = '';
            updateAllUI();
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù ${name} Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function deactivateEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© ${employee.name} Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (${currentMonthKey}) ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ`)) {
                const [startYear, startMonth] = currentMonthKey.split('-').map(Number);
                for (let y = startYear; y < startYear + 5; y++) {
                    for (let m = (y === startYear ? startMonth : 1); m <= 12; m++) {
                        const monthKey = `${y}-${String(m).padStart(2, '0')}`;
                        if (monthlyData[monthKey] && monthlyData[monthKey].employees) {
                            monthlyData[monthKey].employees = monthlyData[monthKey].employees.filter(e => e.id !== employeeId);
                        }
                    }
                }
                saveData();
                updateAllUI();
                alert(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù ${employee.name} Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©.`);
            }
        }
        
        function activateSelectedEmployee() {
            const employeeId = parseInt(document.getElementById('inactiveEmployeesSelect').value);
            if (!employeeId) return;
            const employee = employees.find(emp => emp.id === employeeId);
            if (monthlyData[currentMonthKey] && !monthlyData[currentMonthKey].employees.some(e => e.id === employeeId)) {
                monthlyData[currentMonthKey].employees.push(JSON.parse(JSON.stringify(employee)));
                saveData();
                updateAllUI();
                alert(`ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸Ù ${employee.name} Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ`);
            }
        }

        function permanentlyDeleteEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            if (confirm(`ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù ${employee.name}ØŸ`)) {
                employee.isDeleted = true;
                deactivateEmployee(employeeId); // Also removes them from current and future months
                saveData();
                updateAllUI();
            }
        }

        // Attendance
        function updateAttendance(id, status) {
            const dateInput = document.getElementById('attendanceDate').value;
            if (!dateInput) return;
            if (!monthlyData[currentMonthKey].attendance[id]) {
                monthlyData[currentMonthKey].attendance[id] = {};
            }
            monthlyData[currentMonthKey].attendance[id][dateInput] = status;
            saveData();
            renderAttendanceList();
            updateReport();
        }

        // Advances (now part of main script)
        function addAdvance() {
            const employeeId = parseInt(document.getElementById('advanceEmployeeId').value);
            const date = document.getElementById('advanceDate').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);

            if (!employeeId || !date || isNaN(amount) || amount <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙØŒ ÙˆØªØ§Ø±ÙŠØ®ØŒ ÙˆÙ‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø³Ù„ÙØ©.');
                return;
            }
            if (!monthlyData[currentMonthKey].advances) {
                monthlyData[currentMonthKey].advances = [];
            }
            if (monthlyData[currentMonthKey].advances.some(adv => adv.employeeId === employeeId && adv.date === date)) {
                alert(`ÙŠÙˆØ¬Ø¯ Ø³Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ ØªØ§Ø±ÙŠØ® ${date}.`);
                return;
            }
            monthlyData[currentMonthKey].advances.push({ id: Date.now(), employeeId, date, amount });
            saveData();
            updateReport();
            document.getElementById('advanceAmount').value = '';
            alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­.');
        }

        function clearSingleAdvanceByDate() {
            const employeeId = parseInt(document.getElementById('clearSingleAdvanceEmployeeId').value);
            const date = document.getElementById('clearSingleAdvanceDate').value;
            if (!employeeId || !date) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ®.'); return; }
            const advanceIndex = monthlyData[currentMonthKey].advances.findIndex(adv => adv.employeeId === employeeId && adv.date === date);
            if (advanceIndex === -1) { alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„ÙØ© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ ØªØ§Ø±ÙŠØ® ${date}.`); return; }
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø³Ù„ÙØ© ÙÙŠ ØªØ§Ø±ÙŠØ® ${date}ØŸ`)) {
                monthlyData[currentMonthKey].advances.splice(advanceIndex, 1);
                saveData();
                updateReport();
                alert(`ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­.`);
            }
        }

        function clearAllAdvancesForEmployee() {
            const employeeId = parseInt(document.getElementById('clearAdvanceEmployeeId').value);
            if (!employeeId) return;
            const employee = getCurrentMonthEmployees().find(emp => emp.id === employeeId);
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ù Ù„Ù„Ù…ÙˆØ¸Ù ${employee.name}ØŸ`)) {
                monthlyData[currentMonthKey].advances = monthlyData[currentMonthKey].advances.filter(adv => adv.employeeId !== employeeId);
                saveData();
                updateReport();
                alert(`ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ù Ù„Ù„Ù…ÙˆØ¸Ù.`);
            }
        }
        
        // Rendering Functions
        function renderCurrentMonthEmployeesList() {
            const container = document.getElementById('currentMonthEmployeesList');
            container.innerHTML = '';
            const currentEmployees = getCurrentMonthEmployees();
            if (currentEmployees.length === 0) {
                container.innerHTML = '<div class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù†Ø´Ø·ÙˆÙ†</div>';
                return;
            }
            currentEmployees.forEach(emp => {
                container.innerHTML += `<div class="employee-item active">
                    <div style="font-weight: bold;">${emp.name}</div>
                    <div style="font-size: 0.9rem;">Ø§Ù„Ø±Ø§ØªØ¨: ${emp.dailySalary.toFixed(2)}</div>
                    <button class="btn-danger" onclick="deactivateEmployee(${emp.id})" style="width: 100%; margin-top: 10px; padding: 5px; font-size: 0.8rem;">
                        âŒ Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    </button>
                </div>`;
            });
        }
        
        function renderInactiveEmployeesLists() {
            const select = document.getElementById('inactiveEmployeesSelect');
            const listContainer = document.getElementById('inactiveEmployeesListContainer');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡</option>';
            listContainer.innerHTML = '';
            const inactive = employees.filter(emp => !emp.isDeleted && !getCurrentMonthEmployees().some(e => e.id === emp.id));
            if (inactive.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† ØºÙŠØ± Ù†Ø´Ø·ÙŠÙ†.</div>';
            }
            inactive.forEach(emp => {
                select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
                listContainer.innerHTML += `<div class="inactive-employee-management">
                    <div>${emp.name}</div>
                    <button class="btn-archive" onclick="permanentlyDeleteEmployee(${emp.id})">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                </div>`;
            });
        }
        
        function renderEmployeeSelects() {
            const selects = ['advanceEmployeeId', 'clearSingleAdvanceEmployeeId', 'clearAdvanceEmployeeId'];
            const currentEmployees = getCurrentMonthEmployees();
            selects.forEach(id => {
                const select = document.getElementById(id);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>';
                currentEmployees.forEach(emp => {
                    select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
                });
                select.value = currentValue;
            });
        }

        function renderAttendanceList() {
            const container = document.getElementById('attendanceList');
            const date = document.getElementById('attendanceDate').value;
            container.innerHTML = '';
            const currentEmployees = getCurrentMonthEmployees();
            if (!date) { container.innerHTML = '<div class="empty-state">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ø§Ù‹.</div>'; return; }
            if (currentEmployees.length === 0) { container.innerHTML = '<div class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ†.</div>'; return; }

            currentEmployees.forEach(emp => {
                const status = (monthlyData[currentMonthKey].attendance[emp.id] || {})[date] || 0;
                container.innerHTML += `<div class="attendance-row">
                    <div class="employee-name">${emp.name}</div>
                    <div class="attendance-buttons">
                        <button class="attendance-btn ${status === 1 ? 'active-full' : ''}" onclick="updateAttendance(${emp.id}, 1)">Ø­</button>
                        <button class="attendance-btn ${status === 0.5 ? 'active-half' : ''}" onclick="updateAttendance(${emp.id}, 0.5)">Ù†</button>
                        <button class="attendance-btn ${status === 0 ? 'active-absent' : ''}" onclick="updateAttendance(${emp.id}, 0)">Øº</button>
                    </div>
                </div>`;
            });
        }
        
        // Reports
        function updateReport() {
            const reportMonth = parseInt(document.getElementById('reportMonth').value);
            const reportYear = parseInt(document.getElementById('reportYear').value);
            const reportTable = document.getElementById('reportTable');
            const currentEmployees = getCurrentMonthEmployees();
            if (currentEmployees.length === 0) { reportTable.innerHTML = `<div class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>`; return; }

            let totalDays = 0, totalSalary = 0, totalAdvances = 0, totalNetDue = 0;
            let tableBody = '';
            const daysInMonth = new Date(reportYear, reportMonth + 1, 0).getDate();

            currentEmployees.forEach(emp => {
                let fullDays = 0, halfDays = 0;
                const empAttendance = (monthlyData[currentMonthKey].attendance[emp.id] || {});
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateKey = `${reportYear}-${String(reportMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const status = empAttendance[dateKey] || 0;
                    if (status === 1) fullDays++;
                    else if (status === 0.5) halfDays++;
                }

                const empAdvances = (monthlyData[currentMonthKey].advances || []).filter(adv => adv.employeeId === emp.id);
                const totalMonthlyAdvance = empAdvances.reduce((sum, adv) => sum + adv.amount, 0);
                const totalWorkingDays = fullDays + halfDays * 0.5;
                const netSalary = totalWorkingDays * emp.dailySalary;
                const netDue = netSalary - totalMonthlyAdvance;
                
                totalDays += totalWorkingDays;
                totalSalary += netSalary;
                totalAdvances += totalMonthlyAdvance;
                totalNetDue += netDue;

                tableBody += `<tr>
                    <td class="employee-name">${emp.name}</td><td>${emp.dailySalary.toFixed(2)}</td>
                    <td>${fullDays}</td><td>${halfDays}</td><td class="days-count">${totalWorkingDays.toFixed(1)}</td>
                    <td class="salary-amount">${netSalary.toFixed(2)}</td><td>${totalMonthlyAdvance.toFixed(2)}</td>
                    <td class="salary-amount" style="color:${netDue < 0 ? '#DC2626' : '#059669'};">${netDue.toFixed(2)}</td>
                    <td><button class="btn-view" onclick="showEmployeeDetailsModal(${emp.id})">Ø¹Ø±Ø¶</button></td>
                </tr>`;
            });

            reportTable.innerHTML = `<table><thead>
                <tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø±Ø§ØªØ¨ Ø§Ù„ÙŠÙˆÙ…</th><th>Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©</th><th>Ø£Ù†ØµØ§Ù</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø±Ø§ØªØ¨</th><th>Ø§Ù„Ø³Ù„Ù</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
            </thead><tbody>${tableBody}</tbody><tfoot>
                <tr><td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td class="days-count">${totalDays.toFixed(1)}</td><td class="salary-amount">${totalSalary.toFixed(2)}</td>
                    <td>${totalAdvances.toFixed(2)}</td><td class="salary-amount" style="color:${totalNetDue < 0 ? '#DC2626' : '#059669'};">${totalNetDue.toFixed(2)}</td>
                    <td></td>
                </tr>
            </tfoot></table>`;
        }
        
        // Modal & Printing
        function openAdvancesModal() {
            updateMonthInfo(); // Ensure month name is updated in the modal title
            document.getElementById('advancesModal').classList.add('show');
        }
        
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }

        function showEmployeeDetailsModal(id) {
            const emp = getCurrentMonthEmployees().find(e => e.id === id);
            if (!emp) return;
            const [year, month] = currentMonthKey.split('-').map(Number);
            document.getElementById('modalEmployeeName').textContent = emp.name;
            const daysInMonth = new Date(year, month, 0).getDate();
            const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
            let tableRows = '', totalFull = 0, totalHalf = 0, totalAdvance = 0;
            const empAttendance = (monthlyData[currentMonthKey].attendance[emp.id] || {});
            const empAdvances = (monthlyData[currentMonthKey].advances || []).filter(adv => adv.employeeId === emp.id);

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month - 1, d);
                const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isWeekend = [5, 6].includes(date.getDay());
                const status = empAttendance[dateKey] || 0;
                const advance = empAdvances.find(adv => adv.date === dateKey);
                
                let s = { symbol: 'âŒ', class: 'row-absent' };
                if (isWeekend) s = { symbol: 'ğŸ–ï¸', class: 'row-weekend-highlight' };
                else if (status === 1) { s = { symbol: 'âœ…', class: 'row-full' }; totalFull++; }
                else if (status === 0.5) { s = { symbol: 'â±ï¸', class: 'row-half' }; totalHalf++; }
                
                tableRows += `<tr class="${s.class}"><td>${d}</td><td>${dayNames[date.getDay()]}</td><td class="status-cell">${s.symbol}</td>
                    <td>${advance ? advance.amount.toFixed(2) : ''}</td></tr>`;
            }
            totalAdvance = empAdvances.reduce((sum, adv) => sum + adv.amount, 0);
            const totalWorkDays = totalFull + (totalHalf * 0.5);
            const netDue = (totalWorkDays * emp.dailySalary) - totalAdvance;

            document.getElementById('employeeSummary').innerHTML = `
                <div class="summary-item"><div class="summary-label">Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„</div><div class="summary-value">${totalWorkDays.toFixed(1)}</div></div>
                <div class="summary-item"><div class="summary-label">Ø§Ù„Ø³Ù„Ù</div><div class="summary-value" style="color:#DC2626;">${totalAdvance.toFixed(2)}</div></div>
                <div class="summary-item"><div class="summary-label">Ø§Ù„ØµØ§ÙÙŠ</div><div class="summary-value" style="color:${netDue < 0 ? '#DC2626' : '#059669'};">${netDue.toFixed(2)}</div></div>`;
            document.getElementById('calendarDays').innerHTML = `<table class="attendance-table"><thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø³Ù„ÙØ©</th></tr></thead><tbody>${tableRows}</tbody></table>`;
            document.getElementById('employeeModal').classList.add('show');
        }

        function showMatrixReport() {
            const reportMonth = parseInt(document.getElementById('reportMonth').value);
            const reportYear = parseInt(document.getElementById('reportYear').value);
            const monthText = `${document.getElementById('reportMonth').options[reportMonth].text} ${reportYear}`;
            document.getElementById('printableAreaTitle').textContent = `Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - ${monthText}`;
            document.getElementById('printableContent').innerHTML = generateMatrixHTML(false);
            document.getElementById('printableArea').classList.add('show');
        }

        function showAdvancesMatrixReport() {
            const reportMonth = parseInt(document.getElementById('reportMonth').value);
            const reportYear = parseInt(document.getElementById('reportYear').value);
            const monthText = `${document.getElementById('reportMonth').options[reportMonth].text} ${reportYear}`;
            document.getElementById('printableAreaTitle').textContent = `Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ù„Ù - ${monthText}`;
            document.getElementById('printableContent').innerHTML = generateMatrixHTML(true);
            document.getElementById('printableArea').classList.add('show');
        }

        // *** THIS IS THE MODIFIED FUNCTION ***
        function generateMatrixHTML(advancesOnly = false) {
            const currentEmployees = getCurrentMonthEmployees();
            if (currentEmployees.length === 0) return '<div class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ø¹Ø±Ø¶Ù‡Ù….</div>';

            const [year, month] = currentMonthKey.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

            // Header
            let html = `<table class="matrix-table"><thead><tr><th class="day-col">Ø§Ù„ÙŠÙˆÙ…</th>`;
            currentEmployees.forEach(emp => {
                html += `<th>${emp.name}</th>`;
            });
            html += `</tr></thead><tbody>`;

            // Body Rows (Days)
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month - 1, d);
                const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayOfWeek = date.getDay();
                const isWeekend = [5, 6].includes(dayOfWeek);
                
                html += `<tr class="${isWeekend ? 'status-weekend' : ''}">`;
                html += `<td class="day-col">${d} - ${dayNames[dayOfWeek]}</td>`;

                currentEmployees.forEach(emp => {
                    if (advancesOnly) {
                        const advance = (monthlyData[currentMonthKey].advances || []).find(adv => adv.employeeId === emp.id && adv.date === dateKey);
                        html += `<td class="${advance ? 'status-absent' : ''}">${advance ? advance.amount.toFixed(2) : 'â€”'}</td>`;
                    } else {
                        const status = (monthlyData[currentMonthKey].attendance[emp.id] || {})[dateKey] || 0;
                        let cellContent = 'âŒ';
                        let cellClass = 'status-absent';
                        if (isWeekend) {
                            cellContent = 'ğŸ–ï¸';
                            cellClass = 'status-weekend';
                        } else if (status === 1) {
                            cellContent = 'âœ…';
                            cellClass = 'status-full';
                        } else if (status === 0.5) {
                            cellContent = 'â±ï¸';
                            cellClass = 'status-half';
                        }
                        html += `<td class="${cellClass}">${cellContent}</td>`;
                    }
                });
                html += `</tr>`;
            }
            html += `</tbody>`;

            // Footer (Totals)
            html += `<tfoot>`;
            if (advancesOnly) {
                html += `<tr><td class="day-col">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù</td>`;
                currentEmployees.forEach(emp => {
                    const totalAdvance = (monthlyData[currentMonthKey].advances || [])
                        .filter(adv => adv.employeeId === emp.id)
                        .reduce((sum, adv) => sum + adv.amount, 0);
                    html += `<td class="status-absent">${totalAdvance.toFixed(2)}</td>`;
                });
                html += `</tr>`;
            } else {
                // Total Working Days
                html += `<tr><td class="day-col">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…</td>`;
                currentEmployees.forEach(emp => {
                    let totalWorkingDays = 0;
                    const empAttendance = (monthlyData[currentMonthKey].attendance[emp.id] || {});
                     for (let d = 1; d <= daysInMonth; d++) {
                        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const status = empAttendance[dateKey] || 0;
                        if (status === 1) totalWorkingDays++;
                        else if (status === 0.5) totalWorkingDays += 0.5;
                    }
                    html += `<td class="days-count">${totalWorkingDays.toFixed(1)}</td>`;
                });
                html += `</tr>`;
                
                // Total Advances
                html += `<tr><td class="day-col">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ù</td>`;
                currentEmployees.forEach(emp => {
                     const totalAdvance = (monthlyData[currentMonthKey].advances || [])
                        .filter(adv => adv.employeeId === emp.id)
                        .reduce((sum, adv) => sum + adv.amount, 0);
                    html += `<td class="status-absent">${totalAdvance.toFixed(2)}</td>`;
                });
                html += `</tr>`;

                // Net Salary
                html += `<tr><td class="day-col">Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚</td>`;
                 currentEmployees.forEach(emp => {
                    let totalWorkingDays = 0;
                    const empAttendance = (monthlyData[currentMonthKey].attendance[emp.id] || {});
                     for (let d = 1; d <= daysInMonth; d++) {
                        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const status = empAttendance[dateKey] || 0;
                        if (status === 1) totalWorkingDays++;
                        else if (status === 0.5) totalWorkingDays += 0.5;
                    }
                     const totalAdvance = (monthlyData[currentMonthKey].advances || [])
                        .filter(adv => adv.employeeId === emp.id)
                        .reduce((sum, adv) => sum + adv.amount, 0);
                    const netDue = (totalWorkingDays * emp.dailySalary) - totalAdvance;
                    html += `<td class="salary-amount" style="color:${netDue < 0 ? '#DC2626' : '#059669'};">${netDue.toFixed(2)}</td>`;
                });
                html += `</tr>`;
            }
            html += `</tfoot></table>`;
            return html;
        }

        // Data Backup
        function exportData() {
            const data = { employees, monthlyData };
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                event.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.employees && data.monthlyData) {
                        employees = data.employees;
                        monthlyData = data.monthlyData;
                        saveData();
                        location.reload();
                    } else { alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.'); }
                } catch (err) { alert('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Helper Functions
        const getCurrentMonthEmployees = () => (monthlyData[currentMonthKey] || {}).employees || [];

    </script>
</body>
</html>
